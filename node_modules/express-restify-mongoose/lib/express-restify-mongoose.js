'use strict';

var util = require('util');
var _ = require('lodash');
var Filter = require('./resource_filter');
var customDefaults = null;
var excludedMap = {};

function getDefaults() {
  return _.defaults(_.clone(customDefaults) || {}, {
    prefix: '/api',
    version: '/v1',
    idProperty: '_id',
    findOneAndUpdate: true,
    findOneAndRemove: true,
    lean: true,
    restify: false,
    runValidators: false,
    allowRegex: true,
    private: [],
    protected: []
  });
}

var restify = function restify(app, model) {
  var opts = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};

  var options = {};
  _.assign(options, getDefaults(), opts);

  var access = require('./middleware/access');
  var ensureContentType = require('./middleware/ensureContentType')(options);
  var filterAndFindById = require('./middleware/filterAndFindById')(model, options);
  var onError = require('./middleware/onError');
  var outputFn = require('./middleware/outputFn');
  var prepareQuery = require('./middleware/prepareQuery')(options);
  var prepareOutput = require('./middleware/prepareOutput')(options, excludedMap);

  if (!_.isArray(options.private)) {
    throw new Error('"options.private" must be an array of fields');
  }

  if (!_.isArray(options.protected)) {
    throw new Error('"options.protected" must be an array of fields');
  }

  model.schema.eachPath(function (name, path) {
    if (path.options.access) {
      switch (path.options.access.toLowerCase()) {
        case 'private':
          options.private.push(name);
          break;
        case 'protected':
          options.protected.push(name);
          break;
      }
    }
  });

  options.filter = new Filter({
    model: model,
    excludedMap: excludedMap,
    filteredKeys: {
      private: options.private,
      protected: options.protected
    }
  });

  excludedMap[model.modelName] = options.filter.filteredKeys;

  if (!_.isArray(options.preMiddleware)) {
    options.preMiddleware = options.preMiddleware ? [options.preMiddleware] : [];
  }

  if (!_.isArray(options.preCreate)) {
    options.preCreate = options.preCreate ? [options.preCreate] : [];
  }

  if (!_.isArray(options.preRead)) {
    options.preRead = options.preRead ? [options.preRead] : [];
  }

  if (!_.isArray(options.preUpdate)) {
    options.preUpdate = options.preUpdate ? [options.preUpdate] : [];
  }

  if (!_.isArray(options.preDelete)) {
    options.preDelete = options.preDelete ? [options.preDelete] : [];
  }

  if (!options.contextFilter) {
    options.contextFilter = function (model, req, done) {
      return done(model);
    };
  }

  if (!_.isArray(options.postCreate)) {
    options.postCreate = options.postCreate ? [options.postCreate] : [];
  }

  if (!_.isArray(options.postRead)) {
    options.postRead = options.postRead ? [options.postRead] : [];
  }

  if (!_.isArray(options.postUpdate)) {
    options.postUpdate = options.postUpdate ? [options.postUpdate] : [];
  }

  if (!_.isArray(options.postDelete)) {
    options.postDelete = options.postDelete ? [options.postDelete] : [];
  }

  if (!options.onError) {
    options.onError = onError(!options.restify);
  }

  if (!options.outputFn) {
    options.outputFn = outputFn(!options.restify);
  }

  options.name = options.name || model.modelName;

  var ops = require('./operations')(model, options, excludedMap);

  var uriItem = '' + options.prefix + options.version + '/' + options.name;
  if (uriItem.indexOf('/:id') === -1) {
    uriItem += '/:id';
  }

  var uriItems = uriItem.replace('/:id', '');
  var uriCount = uriItems + '/count';
  var uriShallow = uriItem + '/shallow';

  if (_.isUndefined(app.delete)) {
    app.delete = app.del;
  }

  app.use(function (req, res, next) {
    req.erm = { model: model };
    next();
  });

  var accessMiddleware = options.access ? access(options) : [];

  app.get(uriItems, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItems, prepareOutput);
  app.get(uriCount, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getCount, prepareOutput);
  app.get(uriItem, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItem, prepareOutput);
  app.get(uriShallow, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getShallow, prepareOutput);

  app.post(uriItems, prepareQuery, ensureContentType, options.preMiddleware, options.preCreate, accessMiddleware, ops.createObject, prepareOutput);
  app.post(uriItem, util.deprecate(prepareQuery, 'express-restify-mongoose: in a future major version, the POST method to update resources will be removed. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput);

  app.put(uriItem, util.deprecate(prepareQuery, 'express-restify-mongoose: in a future major version, the PUT method will replace rather than update a resource. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput);
  app.patch(uriItem, prepareQuery, ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput);

  app.delete(uriItems, prepareQuery, options.preMiddleware, options.preDelete, ops.deleteItems, prepareOutput);
  app.delete(uriItem, prepareQuery, options.preMiddleware, options.findOneAndRemove ? [] : filterAndFindById, options.preDelete, ops.deleteItem, prepareOutput);

  return uriItems;
};

module.exports = {
  defaults: function defaults(options) {
    customDefaults = options;
  },
  serve: restify
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9leHByZXNzLXJlc3RpZnktbW9uZ29vc2UuanMiXSwibmFtZXMiOlsidXRpbCIsInJlcXVpcmUiLCJfIiwiRmlsdGVyIiwiY3VzdG9tRGVmYXVsdHMiLCJleGNsdWRlZE1hcCIsImdldERlZmF1bHRzIiwiZGVmYXVsdHMiLCJjbG9uZSIsInByZWZpeCIsInZlcnNpb24iLCJpZFByb3BlcnR5IiwiZmluZE9uZUFuZFVwZGF0ZSIsImZpbmRPbmVBbmRSZW1vdmUiLCJsZWFuIiwicmVzdGlmeSIsInJ1blZhbGlkYXRvcnMiLCJhbGxvd1JlZ2V4IiwicHJpdmF0ZSIsInByb3RlY3RlZCIsImFwcCIsIm1vZGVsIiwib3B0cyIsIm9wdGlvbnMiLCJhc3NpZ24iLCJhY2Nlc3MiLCJlbnN1cmVDb250ZW50VHlwZSIsImZpbHRlckFuZEZpbmRCeUlkIiwib25FcnJvciIsIm91dHB1dEZuIiwicHJlcGFyZVF1ZXJ5IiwicHJlcGFyZU91dHB1dCIsImlzQXJyYXkiLCJFcnJvciIsInNjaGVtYSIsImVhY2hQYXRoIiwibmFtZSIsInBhdGgiLCJ0b0xvd2VyQ2FzZSIsInB1c2giLCJmaWx0ZXIiLCJmaWx0ZXJlZEtleXMiLCJtb2RlbE5hbWUiLCJwcmVNaWRkbGV3YXJlIiwicHJlQ3JlYXRlIiwicHJlUmVhZCIsInByZVVwZGF0ZSIsInByZURlbGV0ZSIsImNvbnRleHRGaWx0ZXIiLCJyZXEiLCJkb25lIiwicG9zdENyZWF0ZSIsInBvc3RSZWFkIiwicG9zdFVwZGF0ZSIsInBvc3REZWxldGUiLCJvcHMiLCJ1cmlJdGVtIiwiaW5kZXhPZiIsInVyaUl0ZW1zIiwicmVwbGFjZSIsInVyaUNvdW50IiwidXJpU2hhbGxvdyIsImlzVW5kZWZpbmVkIiwiZGVsZXRlIiwiZGVsIiwidXNlIiwicmVzIiwibmV4dCIsImVybSIsImFjY2Vzc01pZGRsZXdhcmUiLCJnZXQiLCJnZXRJdGVtcyIsImdldENvdW50IiwiZ2V0SXRlbSIsImdldFNoYWxsb3ciLCJwb3N0IiwiY3JlYXRlT2JqZWN0IiwiZGVwcmVjYXRlIiwibW9kaWZ5T2JqZWN0IiwicHV0IiwicGF0Y2giLCJkZWxldGVJdGVtcyIsImRlbGV0ZUl0ZW0iLCJtb2R1bGUiLCJleHBvcnRzIiwic2VydmUiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTUEsT0FBT0MsUUFBUSxNQUFSLENBQWI7QUFDQSxJQUFNQyxJQUFJRCxRQUFRLFFBQVIsQ0FBVjtBQUNBLElBQU1FLFNBQVNGLFFBQVEsbUJBQVIsQ0FBZjtBQUNBLElBQUlHLGlCQUFpQixJQUFyQjtBQUNBLElBQUlDLGNBQWMsRUFBbEI7O0FBRUEsU0FBU0MsV0FBVCxHQUF3QjtBQUN0QixTQUFPSixFQUFFSyxRQUFGLENBQVdMLEVBQUVNLEtBQUYsQ0FBUUosY0FBUixLQUEyQixFQUF0QyxFQUEwQztBQUMvQ0ssWUFBUSxNQUR1QztBQUUvQ0MsYUFBUyxLQUZzQztBQUcvQ0MsZ0JBQVksS0FIbUM7QUFJL0NDLHNCQUFrQixJQUo2QjtBQUsvQ0Msc0JBQWtCLElBTDZCO0FBTS9DQyxVQUFNLElBTnlDO0FBTy9DQyxhQUFTLEtBUHNDO0FBUS9DQyxtQkFBZSxLQVJnQztBQVMvQ0MsZ0JBQVksSUFUbUM7QUFVL0NDLGFBQVMsRUFWc0M7QUFXL0NDLGVBQVc7QUFYb0MsR0FBMUMsQ0FBUDtBQWFEOztBQUVELElBQU1KLFVBQVUsU0FBVkEsT0FBVSxDQUFVSyxHQUFWLEVBQWVDLEtBQWYsRUFBaUM7QUFBQSxNQUFYQyxJQUFXLHVFQUFKLEVBQUk7O0FBQy9DLE1BQUlDLFVBQVUsRUFBZDtBQUNBckIsSUFBRXNCLE1BQUYsQ0FBU0QsT0FBVCxFQUFrQmpCLGFBQWxCLEVBQWlDZ0IsSUFBakM7O0FBRUEsTUFBTUcsU0FBU3hCLFFBQVEscUJBQVIsQ0FBZjtBQUNBLE1BQU15QixvQkFBb0J6QixRQUFRLGdDQUFSLEVBQTBDc0IsT0FBMUMsQ0FBMUI7QUFDQSxNQUFNSSxvQkFBb0IxQixRQUFRLGdDQUFSLEVBQTBDb0IsS0FBMUMsRUFBaURFLE9BQWpELENBQTFCO0FBQ0EsTUFB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R0FBZ0NlLGlCQUEzRyxFQUE4SEosUUFBUXVCLFNBQXRJLEVBQWlKdUIsZ0JBQWpKLEVBQW1LZCxJQUFJdUIsWUFBdkssRUFBcUwvQyxhQUFyTDs7QUFFQVgsTUFBSTJDLE1BQUosQ0FBV0wsUUFBWCxFQUFxQjVCLFlBQXJCLEVBQW1DUCxRQUFRb0IsYUFBM0MsRUFBMERwQixRQUFRd0IsU0FBbEUsRUFBNkVRLElBQUkwQixXQUFqRixFQUE4RmxELGFBQTlGO0FBQ0FYLE1BQUkyQyxNQUFKLENBQVdQLE9BQVgsRUFBb0IxQixZQUFwQixFQUFrQ1AsUUFBUW9CLGFBQTFDLEVBQXlEcEIsUUFBUVYsZ0JBQVIsR0FBMkIsRUFBM0IsR0FBZ0NjLGlCQUF6RixFQUE0R0osUUFBUXdCLFNBQXBILEVBQStIUSxJQUFJMkIsVUFBbkksRUFBK0luRCxhQUEvSTs7QUFFQSxTQUFPMkIsUUFBUDtBQUNELENBbklEOztBQXFJQXlCLE9BQU9DLE9BQVAsR0FBaUI7QUFDZjdFLFlBQVUsa0JBQVVnQixPQUFWLEVBQW1CO0FBQzNCbkIscUJBQWlCbUIsT0FBakI7QUFDRCxHQUhjO0FBSWY4RCxTQUFPdEU7QUFKUSxDQUFqQiIsImZpbGUiOiJleHByZXNzLXJlc3RpZnktbW9uZ29vc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB1dGlsID0gcmVxdWlyZSgndXRpbCcpXHJcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxyXG5jb25zdCBGaWx0ZXIgPSByZXF1aXJlKCcuL3Jlc291cmNlX2ZpbHRlcicpXHJcbmxldCBjdXN0b21EZWZhdWx0cyA9IG51bGxcclxubGV0IGV4Y2x1ZGVkTWFwID0ge31cclxuXHJcbmZ1bmN0aW9uIGdldERlZmF1bHRzICgpIHtcclxuICByZXR1cm4gXy5kZWZhdWx0cyhfLmNsb25lKGN1c3RvbURlZmF1bHRzKSB8fCB7fSwge1xyXG4gICAgcHJlZml4OiAnL2FwaScsXHJcbiAgICB2ZXJzaW9uOiAnL3YxJyxcclxuICAgIGlkUHJvcGVydHk6ICdfaWQnLFxyXG4gICAgZmluZE9uZUFuZFVwZGF0ZTogdHJ1ZSxcclxuICAgIGZpbmRPbmVBbmRSZW1vdmU6IHRydWUsXHJcbiAgICBsZWFuOiB0cnVlLFxyXG4gICAgcmVzdGlmeTogZmFsc2UsXHJcbiAgICBydW5WYWxpZGF0b3JzOiBmYWxzZSxcclxuICAgIGFsbG93UmVnZXg6IHRydWUsXHJcbiAgICBwcml2YXRlOiBbXSxcclxuICAgIHByb3RlY3RlZDogW11cclxuICB9KVxyXG59XHJcblxyXG5jb25zdCByZXN0aWZ5ID0gZnVuY3Rpb24gKGFwcCwgbW9kZWwsIG9wdHMgPSB7fSkge1xyXG4gIGxldCBvcHRpb25zID0ge31cclxuICBfLmFzc2lnbihvcHRpb25zLCBnZXREZWZhdWx0cygpLCBvcHRzKVxyXG5cclxuICBjb25zdCBhY2Nlc3MgPSByZXF1aXJlKCcuL21pZGRsZXdhcmUvYWNjZXNzJylcclxuICBjb25zdCBlbnN1cmVDb250ZW50VHlwZSA9IHJlcXVpcmUoJy4vbWlkZGxld2FyZS9lbnN1cmVDb250ZW50VHlwZScpKG9wdGlvbnMpXHJcbiAgY29uc3QgZmlsdGVyQW5kRmluZEJ5SWQgPSByZXF1aXJlKCcuL21pZGRsZXdhcmUvZmlsdGVyQW5kRmluZEJ5SWQnKShtb2RlbCwgb3B0aW9ucylcclxuICBjb25zdCBvbkVycm9yID0gcmVxdWlyZSgnLi9taWRkbGV3YXJlL29uRXJyb3InKVxyXG4gIGNvbnN0IG91dHB1dEZuID0gcmVxdWlyZSgnLi9taWRkbGV3YXJlL291dHB1dEZuJylcclxuICBjb25zdCBwcmVwYXJlUXVlcnkgPSByZXF1aXJlKCcuL21pZGRsZXdhcmUvcHJlcGFyZVF1ZXJ5Jykob3B0aW9ucylcclxuICBjb25zdCBwcmVwYXJlT3V0cHV0ID0gcmVxdWlyZSgnLi9taWRkbGV3YXJlL3ByZXBhcmVPdXRwdXQnKShvcHRpb25zLCBleGNsdWRlZE1hcClcclxuXHJcbiAgaWYgKCFfLmlzQXJyYXkob3B0aW9ucy5wcml2YXRlKSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdcIm9wdGlvbnMucHJpdmF0ZVwiIG11c3QgYmUgYW4gYXJyYXkgb2YgZmllbGRzJylcclxuICB9XHJcblxyXG4gIGlmICghXy5pc0FycmF5KG9wdGlvbnMucHJvdGVjdGVkKSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdcIm9wdGlvbnMucHJvdGVjdGVkXCIgbXVzdCBiZSBhbiBhcnJheSBvZiBmaWVsZHMnKVxyXG4gIH1cclxuXHJcbiAgbW9kZWwuc2NoZW1hLmVhY2hQYXRoKChuYW1lLCBwYXRoKSA9PiB7XHJcbiAgICBpZiAocGF0aC5vcHRpb25zLmFjY2Vzcykge1xyXG4gICAgICBzd2l0Y2ggKHBhdGgub3B0aW9ucy5hY2Nlc3MudG9Mb3dlckNhc2UoKSkge1xyXG4gICAgICAgIGNhc2UgJ3ByaXZhdGUnOlxyXG4gICAgICAgICAgb3B0aW9ucy5wcml2YXRlLnB1c2gobmFtZSlcclxuICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgY2FzZSAncHJvdGVjdGVkJzpcclxuICAgICAgICAgIG9wdGlvbnMucHJvdGVjdGVkLnB1c2gobmFtZSlcclxuICAgICAgICAgIGJyZWFrXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9KVxyXG5cclxuICBvcHRpb25zLmZpbHRlciA9IG5ldyBGaWx0ZXIoe1xyXG4gICAgbW9kZWwsXHJcbiAgICBleGNsdWRlZE1hcCxcclxuICAgIGZpbHRlcmVkS2V5czoge1xyXG4gICAgICBwcml2YXRlOiBvcHRpb25zLnByaXZhdGUsXHJcbiAgICAgIHByb3RlY3RlZDogb3B0aW9ucy5wcm90ZWN0ZWRcclxuICAgIH1cclxuICB9KVxyXG5cclxuICBleGNsdWRlZE1hcFttb2RlbC5tb2RlbE5hbWVdID0gb3B0aW9ucy5maWx0ZXIuZmlsdGVyZWRLZXlzXHJcblxyXG4gIGlmICghXy5pc0FycmF5KG9wdGlvbnMucHJlTWlkZGxld2FyZSkpIHtcclxuICAgIG9wdGlvbnMucHJlTWlkZGxld2FyZSA9IG9wdGlvbnMucHJlTWlkZGxld2FyZSA/IFtvcHRpb25zLnByZU1pZGRsZXdhcmVdIDogW11cclxuICB9XHJcblxyXG4gIGlmICghXy5pc0FycmF5KG9wdGlvbnMucHJlQ3JlYXRlKSkge1xyXG4gICAgb3B0aW9ucy5wcmVDcmVhdGUgPSBvcHRpb25zLnByZUNyZWF0ZSA/IFtvcHRpb25zLnByZUNyZWF0ZV0gOiBbXVxyXG4gIH1cclxuXHJcbiAgaWYgKCFfLmlzQXJyYXkob3B0aW9ucy5wcmVSZWFkKSkge1xyXG4gICAgb3B0aW9ucy5wcmVSZWFkID0gb3B0aW9ucy5wcmVSZWFkID8gW29wdGlvbnMucHJlUmVhZF0gOiBbXVxyXG4gIH1cclxuXHJcbiAgaWYgKCFfLmlzQXJyYXkob3B0aW9ucy5wcmVVcGRhdGUpKSB7XHJcbiAgICBvcHRpb25zLnByZVVwZGF0ZSA9IG9wdGlvbnMucHJlVXBkYXRlID8gW29wdGlvbnMucHJlVXBkYXRlXSA6IFtdXHJcbiAgfVxyXG5cclxuICBpZiAoIV8uaXNBcnJheShvcHRpb25zLnByZURlbGV0ZSkpIHtcclxuICAgIG9wdGlvbnMucHJlRGVsZXRlID0gb3B0aW9ucy5wcmVEZWxldGUgPyBbb3B0aW9ucy5wcmVEZWxldGVdIDogW11cclxuICB9XHJcblxyXG4gIGlmICghb3B0aW9ucy5jb250ZXh0RmlsdGVyKSB7XHJcbiAgICBvcHRpb25zLmNvbnRleHRGaWx0ZXIgPSAobW9kZWwsIHJlcSwgZG9uZSkgPT4gZG9uZShtb2RlbClcclxuICB9XHJcblxyXG4gIGlmICghXy5pc0FycmF5KG9wdGlvbnMucG9zdENyZWF0ZSkpIHtcclxuICAgIG9wdGlvbnMucG9zdENyZWF0ZSA9IG9wdGlvbnMucG9zdENyZWF0ZSA/IFtvcHRpb25zLnBvc3RDcmVhdGVdIDogW11cclxuICB9XHJcblxyXG4gIGlmICghXy5pc0FycmF5KG9wdGlvbnMucG9zdFJlYWQpKSB7XHJcbiAgICBvcHRpb25zLnBvc3RSZWFkID0gb3B0aW9ucy5wb3N0UmVhZCA/IFtvcHRpb25zLnBvc3RSZWFkXSA6IFtdXHJcbiAgfVxyXG5cclxuICBpZiAoIV8uaXNBcnJheShvcHRpb25zLnBvc3RVcGRhdGUpKSB7XHJcbiAgICBvcHRpb25zLnBvc3RVcGRhdGUgPSBvcHRpb25zLnBvc3RVcGRhdGUgPyBbb3B0aW9ucy5wb3N0VXBkYXRlXSA6IFtdXHJcbiAgfVxyXG5cclxuICBpZiAoIV8uaXNBcnJheShvcHRpb25zLnBvc3REZWxldGUpKSB7XHJcbiAgICBvcHRpb25zLnBvc3REZWxldGUgPSBvcHRpb25zLnBvc3REZWxldGUgPyBbb3B0aW9ucy5wb3N0RGVsZXRlXSA6IFtdXHJcbiAgfVxyXG5cclxuICBpZiAoIW9wdGlvbnMub25FcnJvcikge1xyXG4gICAgb3B0aW9ucy5vbkVycm9yID0gb25FcnJvcighb3B0aW9ucy5yZXN0aWZ5KVxyXG4gIH1cclxuXHJcbiAgaWYgKCFvcHRpb25zLm91dHB1dEZuKSB7XHJcbiAgICBvcHRpb25zLm91dHB1dEZuID0gb3V0cHV0Rm4oIW9wdGlvbnMucmVzdGlmeSlcclxuICB9XHJcblxyXG4gIG9wdGlvbnMubmFtZSA9IG9wdGlvbnMubmFtZSB8fCBtb2RlbC5tb2RlbE5hbWVcclxuXHJcbiAgY29uc3Qgb3BzID0gcmVxdWlyZSgnLi9vcGVyYXRpb25zJykobW9kZWwsIG9wdGlvbnMsIGV4Y2x1ZGVkTWFwKVxyXG5cclxuICBsZXQgdXJpSXRlbSA9IGAke29wdGlvbnMucHJlZml4fSR7b3B0aW9ucy52ZXJzaW9ufS8ke29wdGlvbnMubmFtZX1gXHJcbiAgaWYgKHVyaUl0ZW0uaW5kZXhPZignLzppZCcpID09PSAtMSkge1xyXG4gICAgdXJpSXRlbSArPSAnLzppZCdcclxuICB9XHJcblxyXG4gIGNvbnN0IHVyaUl0ZW1zID0gdXJpSXRlbS5yZXBsYWNlKCcvOmlkJywgJycpXHJcbiAgY29uc3QgdXJpQ291bnQgPSB1cmlJdGVtcyArICcvY291bnQnXHJcbiAgY29uc3QgdXJpU2hhbGxvdyA9IHVyaUl0ZW0gKyAnL3NoYWxsb3cnXHJcblxyXG4gIGlmIChfLmlzVW5kZWZpbmVkKGFwcC5kZWxldGUpKSB7XHJcbiAgICBhcHAuZGVsZXRlID0gYXBwLmRlbFxyXG4gIH1cclxuXHJcbiAgYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAgIHJlcS5lcm0gPSB7IG1vZGVsIH1cclxuICAgIG5leHQoKVxyXG4gIH0pXHJcblxyXG4gIGNvbnN0IGFjY2Vzc01pZGRsZXdhcmUgPSBvcHRpb25zLmFjY2VzcyA/IGFjY2VzcyhvcHRpb25zKSA6IFtdXHJcblxyXG4gIGFwcC5nZXQodXJpSXRlbXMsIHByZXBhcmVRdWVyeSwgb3B0aW9ucy5wcmVNaWRkbGV3YXJlLCBvcHRpb25zLnByZVJlYWQsIGFjY2Vzc01pZGRsZXdhcmUsIG9wcy5nZXRJdGVtcywgcHJlcGFyZU91dHB1dClcclxuICBhcHAuZ2V0KHVyaUNvdW50LCBwcmVwYXJlUXVlcnksIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5wcmVSZWFkLCBhY2Nlc3NNaWRkbGV3YXJlLCBvcHMuZ2V0Q291bnQsIHByZXBhcmVPdXRwdXQpXHJcbiAgYXBwLmdldCh1cmlJdGVtLCBwcmVwYXJlUXVlcnksIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5wcmVSZWFkLCBhY2Nlc3NNaWRkbGV3YXJlLCBvcHMuZ2V0SXRlbSwgcHJlcGFyZU91dHB1dClcclxuICBhcHAuZ2V0KHVyaVNoYWxsb3csIHByZXBhcmVRdWVyeSwgb3B0aW9ucy5wcmVNaWRkbGV3YXJlLCBvcHRpb25zLnByZVJlYWQsIGFjY2Vzc01pZGRsZXdhcmUsIG9wcy5nZXRTaGFsbG93LCBwcmVwYXJlT3V0cHV0KVxyXG5cclxuICBhcHAucG9zdCh1cmlJdGVtcywgcHJlcGFyZVF1ZXJ5LCBlbnN1cmVDb250ZW50VHlwZSwgb3B0aW9ucy5wcmVNaWRkbGV3YXJlLCBvcHRpb25zLnByZUNyZWF0ZSwgYWNjZXNzTWlkZGxld2FyZSwgb3BzLmNyZWF0ZU9iamVjdCwgcHJlcGFyZU91dHB1dClcclxuICBhcHAucG9zdCh1cmlJdGVtLCB1dGlsLmRlcHJlY2F0ZShwcmVwYXJlUXVlcnksICdleHByZXNzLXJlc3RpZnktbW9uZ29vc2U6IGluIGEgZnV0dXJlIG1ham9yIHZlcnNpb24sIHRoZSBQT1NUIG1ldGhvZCB0byB1cGRhdGUgcmVzb3VyY2VzIHdpbGwgYmUgcmVtb3ZlZC4gVXNlIFBBVENIIGluc3RlYWQuJyksIGVuc3VyZUNvbnRlbnRUeXBlLCBvcHRpb25zLnByZU1pZGRsZXdhcmUsIG9wdGlvbnMuZmluZE9uZUFuZFVwZGF0ZSA/IFtdIDogZmlsdGVyQW5kRmluZEJ5SWQsIG9wdGlvbnMucHJlVXBkYXRlLCBhY2Nlc3NNaWRkbGV3YXJlLCBvcHMubW9kaWZ5T2JqZWN0LCBwcmVwYXJlT3V0cHV0KVxyXG5cclxuICBhcHAucHV0KHVyaUl0ZW0sIHV0aWwuZGVwcmVjYXRlKHByZXBhcmVRdWVyeSwgJ2V4cHJlc3MtcmVzdGlmeS1tb25nb29zZTogaW4gYSBmdXR1cmUgbWFqb3IgdmVyc2lvbiwgdGhlIFBVVCBtZXRob2Qgd2lsbCByZXBsYWNlIHJhdGhlciB0aGFuIHVwZGF0ZSBhIHJlc291cmNlLiBVc2UgUEFUQ0ggaW5zdGVhZC4nKSwgZW5zdXJlQ29udGVudFR5cGUsIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5maW5kT25lQW5kVXBkYXRlID8gW10gOiBmaWx0ZXJBbmRGaW5kQnlJZCwgb3B0aW9ucy5wcmVVcGRhdGUsIGFjY2Vzc01pZGRsZXdhcmUsIG9wcy5tb2RpZnlPYmplY3QsIHByZXBhcmVPdXRwdXQpXHJcbiAgYXBwLnBhdGNoKHVyaUl0ZW0sIHByZXBhcmVRdWVyeSwgZW5zdXJlQ29udGVudFR5cGUsIG9wdGlvbnMucHJlTWlkZGxld2FyZSwgb3B0aW9ucy5maW5kT25lQW5kVXBkYXRlID8gW10gOiBmaWx0ZXJBbmRGaW5kQnlJZCwgb3B0aW9ucy5wcmVVcGRhdGUsIGFjY2Vzc01pZGRsZXdhcmUsIG9wcy5tb2RpZnlPYmplY3QsIHByZXBhcmVPdXRwdXQpXHJcblxyXG4gIGFwcC5kZWxldGUodXJpSXRlbXMsIHByZXBhcmVRdWVyeSwgb3B0aW9ucy5wcmVNaWRkbGV3YXJlLCBvcHRpb25zLnByZURlbGV0ZSwgb3BzLmRlbGV0ZUl0ZW1zLCBwcmVwYXJlT3V0cHV0KVxyXG4gIGFwcC5kZWxldGUodXJpSXRlbSwgcHJlcGFyZVF1ZXJ5LCBvcHRpb25zLnByZU1pZGRsZXdhcmUsIG9wdGlvbnMuZmluZE9uZUFuZFJlbW92ZSA/IFtdIDogZmlsdGVyQW5kRmluZEJ5SWQsIG9wdGlvbnMucHJlRGVsZXRlLCBvcHMuZGVsZXRlSXRlbSwgcHJlcGFyZU91dHB1dClcclxuXHJcbiAgcmV0dXJuIHVyaUl0ZW1zXHJcbn1cclxuXHJcbm1vZHVsZS5leHBvcnRzID0ge1xyXG4gIGRlZmF1bHRzOiBmdW5jdGlvbiAob3B0aW9ucykge1xyXG4gICAgY3VzdG9tRGVmYXVsdHMgPSBvcHRpb25zXHJcbiAgfSxcclxuICBzZXJ2ZTogcmVzdGlmeVxyXG59XHJcbiJdfQ==
//# sourceMappingURL=express-restify-mongoose.js.map