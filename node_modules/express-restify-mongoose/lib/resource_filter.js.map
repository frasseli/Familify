{"version":3,"sources":["../src/resource_filter.js"],"names":["_","require","detective","weedout","Filter","opts","model","filteredKeys","isPlainObject","private","protected","discriminators","excludedMap","modelName","concat","prototype","getExcluded","access","entry","isExcluded","field","defaults","indexOf","filterItem","item","excluded","isArray","map","i","isFunction","toObject","length","filterPopulatedItem","populate","path","has","get","pathToArray","split","slice","join","array","pathToObject","filterObject","resource","filtered","module","exports"],"mappings":";;AAAA,IAAMA,IAAIC,QAAQ,QAAR,CAAV;AACA,IAAMC,YAAYD,QAAQ,oBAAR,CAAlB;AACA,IAAME,UAAUF,QAAQ,SAAR,CAAhB;;AAEA;;;;;;;;AAQA,SAASG,MAAT,CAAiBC,IAAjB,EAAuB;AACrB,OAAKC,KAAL,GAAaD,KAAKC,KAAlB;;AAEA,OAAKC,YAAL,GAAoBP,EAAEQ,aAAF,CAAgBH,KAAKE,YAArB,IAAqC;AACvDE,aAASJ,KAAKE,YAAL,CAAkBE,OAAlB,IAA6B,EADiB;AAEvDC,eAAWL,KAAKE,YAAL,CAAkBG,SAAlB,IAA+B;AAFa,GAArC,GAGhB;AACFD,aAAS,EADP;AAEFC,eAAW;AAFT,GAHJ;;AAQA,MAAI,KAAKJ,KAAL,IAAc,KAAKA,KAAL,CAAWK,cAAzB,IAA2CX,EAAEQ,aAAF,CAAgBH,KAAKO,WAArB,CAA/C,EAAkF;AAChF,SAAK,IAAIC,SAAT,IAAsB,KAAKP,KAAL,CAAWK,cAAjC,EAAiD;AAC/C,UAAIN,KAAKO,WAAL,CAAiBC,SAAjB,CAAJ,EAAiC;AAC/B,aAAKN,YAAL,CAAkBE,OAAlB,GAA4B,KAAKF,YAAL,CAAkBE,OAAlB,CAA0BK,MAA1B,CAAiCT,KAAKO,WAAL,CAAiBC,SAAjB,EAA4BJ,OAA7D,CAA5B;AACA,aAAKF,YAAL,CAAkBG,SAAlB,GAA8B,KAAKH,YAAL,CAAkBG,SAAlB,CAA4BI,MAA5B,CAAmCT,KAAKO,WAAL,CAAiBC,SAAjB,EAA4BH,SAA/D,CAA9B;AACD;AACF;AACF;AACF;;AAED;;;;;;;;;AASAN,OAAOW,SAAP,CAAiBC,WAAjB,GAA+B,UAAUX,IAAV,EAAgB;AAC7C,MAAIA,KAAKY,MAAL,KAAgB,SAApB,EAA+B;AAC7B,WAAO,EAAP;AACD;;AAED,MAAIC,QAAQb,KAAKO,WAAL,IAAoBP,KAAKQ,SAAzB,GAAqCR,KAAKO,WAAL,CAAiBP,KAAKQ,SAAtB,CAArC,GAAwE,IAApF;;AAEA,MAAI,CAACK,KAAL,EAAY;AACVA,YAAQlB,EAAEQ,aAAF,CAAgBH,KAAKE,YAArB,IAAqC;AAC3CE,eAASJ,KAAKE,YAAL,CAAkBE,OAAlB,IAA6B,EADK;AAE3CC,iBAAWL,KAAKE,YAAL,CAAkBG,SAAlB,IAA+B;AAFC,KAArC,GAGJ;AACFD,eAAS,EADP;AAEFC,iBAAW;AAFT,KAHJ;AAOD;;AAED,SAAOL,KAAKY,MAAL,KAAgB,WAAhB,GAA8BC,MAAMT,OAApC,GAA8CS,MAAMT,OAAN,CAAcK,MAAd,CAAqBI,MAAMR,SAA3B,CAArD;AACD,CAlBD;;AAoBAN,OAAOW,SAAP,CAAiBI,UAAjB,GAA8B,UAAUC,KAAV,EAAiBf,IAAjB,EAAuB;AACnD,MAAI,CAACe,KAAL,EAAY;AACV,WAAO,KAAP;AACD;;AAEDf,SAAOL,EAAEqB,QAAF,CAAWhB,IAAX,EAAiB;AACtBY,YAAQ,QADc;AAEtBL,iBAAa,EAFS;AAGtBL,kBAAc,KAAKA,YAHG;AAItBM,eAAW,KAAKP,KAAL,CAAWO;AAJA,GAAjB,CAAP;;AAOA,SAAO,KAAKG,WAAL,CAAiBX,IAAjB,EAAuBiB,OAAvB,CAA+BF,KAA/B,KAAyC,CAAhD;AACD,CAbD;;AAeA;;;;;;;AAOAhB,OAAOW,SAAP,CAAiBQ,UAAjB,GAA8B,UAAUC,IAAV,EAAgBC,QAAhB,EAA0B;AAAA;;AACtD,MAAIzB,EAAE0B,OAAF,CAAUF,IAAV,CAAJ,EAAqB;AACnB,WAAOA,KAAKG,GAAL,CAAS,UAACC,CAAD;AAAA,aAAO,MAAKL,UAAL,CAAgBK,CAAhB,EAAmBH,QAAnB,CAAP;AAAA,KAAT,CAAP;AACD;;AAED,MAAID,QAAQC,QAAZ,EAAsB;AACpB,QAAIzB,EAAE6B,UAAF,CAAaL,KAAKM,QAAlB,CAAJ,EAAiC;AAC/BN,aAAOA,KAAKM,QAAL,EAAP;AACD;;AAED,SAAK,IAAIF,IAAI,CAAR,EAAWG,SAASN,SAASM,MAAlC,EAA0CH,IAAIG,MAA9C,EAAsDH,GAAtD,EAA2D;AACzD,UAAIH,SAASG,CAAT,EAAYN,OAAZ,CAAoB,GAApB,IAA2B,CAA/B,EAAkC;AAChCnB,gBAAQqB,IAAR,EAAcC,SAASG,CAAT,CAAd;AACD,OAFD,MAEO;AACL,eAAOJ,KAAKC,SAASG,CAAT,CAAL,CAAP;AACD;AACF;AACF;;AAED,SAAOJ,IAAP;AACD,CApBD;;AAsBA;;;;;;;;;;AAUApB,OAAOW,SAAP,CAAiBiB,mBAAjB,GAAuC,UAAUR,IAAV,EAAgBnB,IAAhB,EAAsB;AAAA;;AAC3D,MAAIL,EAAE0B,OAAF,CAAUF,IAAV,CAAJ,EAAqB;AACnB,WAAOA,KAAKG,GAAL,CAAS,UAACC,CAAD;AAAA,aAAO,OAAKI,mBAAL,CAAyBJ,CAAzB,EAA4BvB,IAA5B,CAAP;AAAA,KAAT,CAAP;AACD;;AAED,OAAK,IAAIuB,IAAI,CAAb,EAAgBA,IAAIvB,KAAK4B,QAAL,CAAcF,MAAlC,EAA0CH,GAA1C,EAA+C;AAC7C,QAAI,CAACvB,KAAK4B,QAAL,CAAcL,CAAd,EAAiBM,IAAtB,EAA4B;AAC1B;AACD;;AAED,QAAMT,WAAW,KAAKT,WAAL,CAAiB;AAChCC,cAAQZ,KAAKY,MADmB;AAEhCL,mBAAaP,KAAKO,WAFc;AAGhCC,iBAAWX,UAAU,KAAKI,KAAf,EAAsBD,KAAK4B,QAAL,CAAcL,CAAd,EAAiBM,IAAvC;AAHqB,KAAjB,CAAjB;;AAMA,QAAIlC,EAAEmC,GAAF,CAAMX,IAAN,EAAYnB,KAAK4B,QAAL,CAAcL,CAAd,EAAiBM,IAA7B,CAAJ,EAAwC;AACtC,WAAKX,UAAL,CAAgBvB,EAAEoC,GAAF,CAAMZ,IAAN,EAAYnB,KAAK4B,QAAL,CAAcL,CAAd,EAAiBM,IAA7B,CAAhB,EAAoDT,QAApD;AACD,KAFD,MAEO;AACL,UAAMY,cAAchC,KAAK4B,QAAL,CAAcL,CAAd,EAAiBM,IAAjB,CAAsBI,KAAtB,CAA4B,GAA5B,EAAiCC,KAAjC,CAAuC,CAAvC,EAA0C,CAAC,CAA3C,EAA8CC,IAA9C,CAAmD,GAAnD,CAApB;;AAEA,UAAIxC,EAAEmC,GAAF,CAAMX,IAAN,EAAYa,WAAZ,CAAJ,EAA8B;AAC5B,YAAMI,QAAQzC,EAAEoC,GAAF,CAAMZ,IAAN,EAAYa,WAAZ,CAAd;AACA,YAAMK,eAAerC,KAAK4B,QAAL,CAAcL,CAAd,EAAiBM,IAAjB,CAAsBI,KAAtB,CAA4B,GAA5B,EAAiCC,KAAjC,CAAuC,CAAC,CAAxC,EAA2CC,IAA3C,CAAgD,GAAhD,CAArB;;AAEA,aAAKjB,UAAL,CAAgBvB,EAAE2B,GAAF,CAAMc,KAAN,EAAaC,YAAb,CAAhB,EAA4CjB,QAA5C;AACD;AACF;AACF;;AAED,SAAOD,IAAP;AACD,CA/BD;;AAiCA;;;;;;;;;;;AAWApB,OAAOW,SAAP,CAAiB4B,YAAjB,GAAgC,UAAUC,QAAV,EAA+B;AAAA,MAAXvC,IAAW,uEAAJ,EAAI;;AAC7DA,SAAOL,EAAEqB,QAAF,CAAWhB,IAAX,EAAiB;AACtBY,YAAQ,QADc;AAEtBL,iBAAa,EAFS;AAGtBL,kBAAc,KAAKA,YAHG;AAItBM,eAAW,KAAKP,KAAL,CAAWO;AAJA,GAAjB,CAAP;;AAOA,MAAIgC,WAAW,KAAKtB,UAAL,CAAgBqB,QAAhB,EAA0B,KAAK5B,WAAL,CAAiBX,IAAjB,CAA1B,CAAf;;AAEA,MAAIA,KAAK4B,QAAT,EAAmB;AACjB,SAAKD,mBAAL,CAAyBa,QAAzB,EAAmCxC,IAAnC;AACD;;AAED,SAAOwC,QAAP;AACD,CAfD;;AAiBAC,OAAOC,OAAP,GAAiB3C,MAAjB","file":"resource_filter.js","sourcesContent":["const _ = require('lodash')\r\nconst detective = require('mongoose-detective')\r\nconst weedout = require('weedout')\r\n\r\n/**\r\n * Represents a filter.\r\n * @constructor\r\n * @param {Object} opts - Options\r\n * @param {Object} opts.model - Mongoose model\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @param {Object} opts.filteredKeys {} - Keys to filter for the current model\r\n */\r\nfunction Filter (opts) {\r\n  this.model = opts.model\r\n\r\n  this.filteredKeys = _.isPlainObject(opts.filteredKeys) ? {\r\n    private: opts.filteredKeys.private || [],\r\n    protected: opts.filteredKeys.protected || []\r\n  } : {\r\n    private: [],\r\n    protected: []\r\n  }\r\n\r\n  if (this.model && this.model.discriminators && _.isPlainObject(opts.excludedMap)) {\r\n    for (let modelName in this.model.discriminators) {\r\n      if (opts.excludedMap[modelName]) {\r\n        this.filteredKeys.private = this.filteredKeys.private.concat(opts.excludedMap[modelName].private)\r\n        this.filteredKeys.protected = this.filteredKeys.protected.concat(opts.excludedMap[modelName].protected)\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Gets excluded keys for a given model and access.\r\n * @memberof Filter\r\n * @param {Object} - Options.\r\n * @param {String} opts.access {public} - Access level (private, protected or public).\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @param {Object} opts.filteredKeys {} - Keys to filter for the current model\r\n * @returns {Array} - Keys to filter.\r\n */\r\nFilter.prototype.getExcluded = function (opts) {\r\n  if (opts.access === 'private') {\r\n    return []\r\n  }\r\n\r\n  let entry = opts.excludedMap && opts.modelName ? opts.excludedMap[opts.modelName] : null\r\n\r\n  if (!entry) {\r\n    entry = _.isPlainObject(opts.filteredKeys) ? {\r\n      private: opts.filteredKeys.private || [],\r\n      protected: opts.filteredKeys.protected || []\r\n    } : {\r\n      private: [],\r\n      protected: []\r\n    }\r\n  }\r\n\r\n  return opts.access === 'protected' ? entry.private : entry.private.concat(entry.protected)\r\n}\r\n\r\nFilter.prototype.isExcluded = function (field, opts) {\r\n  if (!field) {\r\n    return false\r\n  }\r\n\r\n  opts = _.defaults(opts, {\r\n    access: 'public',\r\n    excludedMap: {},\r\n    filteredKeys: this.filteredKeys,\r\n    modelName: this.model.modelName\r\n  })\r\n\r\n  return this.getExcluded(opts).indexOf(field) >= 0\r\n}\r\n\r\n/**\r\n * Removes excluded keys from a document.\r\n * @memberof Filter\r\n * @param {Object} - Source document.\r\n * @param {Array} - Keys to filter.\r\n * @returns {Object} - Filtered document.\r\n */\r\nFilter.prototype.filterItem = function (item, excluded) {\r\n  if (_.isArray(item)) {\r\n    return item.map((i) => this.filterItem(i, excluded))\r\n  }\r\n\r\n  if (item && excluded) {\r\n    if (_.isFunction(item.toObject)) {\r\n      item = item.toObject()\r\n    }\r\n\r\n    for (let i = 0, length = excluded.length; i < length; i++) {\r\n      if (excluded[i].indexOf('.') > 0) {\r\n        weedout(item, excluded[i])\r\n      } else {\r\n        delete item[excluded[i]]\r\n      }\r\n    }\r\n  }\r\n\r\n  return item\r\n}\r\n\r\n/**\r\n * Removes excluded keys from a document with populated subdocuments.\r\n * @memberof Filter\r\n * @param {Object} - Source document.\r\n * @param {Object} - Keys to filter.\r\n * @param {Array} opts.populate - Paths to populated subdocuments.\r\n * @param {String} opts.access - Access level (private, protected or public).\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @returns {Object} - Filtered document.\r\n */\r\nFilter.prototype.filterPopulatedItem = function (item, opts) {\r\n  if (_.isArray(item)) {\r\n    return item.map((i) => this.filterPopulatedItem(i, opts))\r\n  }\r\n\r\n  for (let i = 0; i < opts.populate.length; i++) {\r\n    if (!opts.populate[i].path) {\r\n      continue\r\n    }\r\n\r\n    const excluded = this.getExcluded({\r\n      access: opts.access,\r\n      excludedMap: opts.excludedMap,\r\n      modelName: detective(this.model, opts.populate[i].path)\r\n    })\r\n\r\n    if (_.has(item, opts.populate[i].path)) {\r\n      this.filterItem(_.get(item, opts.populate[i].path), excluded)\r\n    } else {\r\n      const pathToArray = opts.populate[i].path.split('.').slice(0, -1).join('.')\r\n\r\n      if (_.has(item, pathToArray)) {\r\n        const array = _.get(item, pathToArray)\r\n        const pathToObject = opts.populate[i].path.split('.').slice(-1).join('.')\r\n\r\n        this.filterItem(_.map(array, pathToObject), excluded)\r\n      }\r\n    }\r\n  }\r\n\r\n  return item\r\n}\r\n\r\n/**\r\n * Removes excluded keys from a document.\r\n * @memberof Filter\r\n * @access public\r\n * @param {Object} - Source document.\r\n * @param {Object} - Options.\r\n * @param {String} opts.access {public} - Access level (private, protected or public).\r\n * @param {Object} opts.excludedMap {} - Filtered keys for related models\r\n * @param {Array} opts.populate - Paths to populated subdocuments.\r\n * @returns {Object} - Filtered document.\r\n */\r\nFilter.prototype.filterObject = function (resource, opts = {}) {\r\n  opts = _.defaults(opts, {\r\n    access: 'public',\r\n    excludedMap: {},\r\n    filteredKeys: this.filteredKeys,\r\n    modelName: this.model.modelName\r\n  })\r\n\r\n  let filtered = this.filterItem(resource, this.getExcluded(opts))\r\n\r\n  if (opts.populate) {\r\n    this.filterPopulatedItem(filtered, opts)\r\n  }\r\n\r\n  return filtered\r\n}\r\n\r\nmodule.exports = Filter\r\n"]}