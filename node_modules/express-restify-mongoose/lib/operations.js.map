{"version":3,"sources":["../src/operations.js"],"names":["_","require","http","moredots","module","exports","model","options","excludedMap","buildQuery","errorHandler","findById","filteredContext","id","findOne","and","idProperty","isDistinctExcluded","req","filter","isExcluded","_ermQueryOptions","access","getItems","res","next","erm","result","statusCode","contextFilter","find","then","items","totalCountHeader","countFilteredContext","count","assign","skip","limit","totalCount","getCount","getShallow","params","item","Error","STATUS_CODES","prop","deleteItems","remove","getItem","deleteItem","findOneAndRemove","document","createObject","body","filterObject","populate","schema","_id","versionKey","create","modifyObject","depopulate","src","dst","key","path","caster","instance","isArray","j","length","isPlainObject","isUndefined","cleanBody","findOneAndUpdate","$set","new","runValidators","exec","set","save"],"mappings":"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","file":"operations.js","sourcesContent":["const _ = require('lodash')\r\nconst http = require('http')\r\nconst moredots = require('moredots')\r\n\r\nmodule.exports = function (model, options, excludedMap) {\r\n  const buildQuery = require('./buildQuery')(options)\r\n  const errorHandler = require('./errorHandler')(options)\r\n\r\n  function findById (filteredContext, id) {\r\n    return filteredContext.findOne().and({\r\n      [options.idProperty]: id\r\n    })\r\n  }\r\n\r\n  function isDistinctExcluded (req) {\r\n    return options.filter.isExcluded(req._ermQueryOptions['distinct'], {\r\n      access: req.access,\r\n      excludedMap: excludedMap\r\n    })\r\n  }\r\n\r\n  function getItems (req, res, next) {\r\n    if (isDistinctExcluded(req)) {\r\n      req.erm.result = []\r\n      req.erm.statusCode = 200\r\n      return next()\r\n    }\r\n\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(filteredContext.find(), req._ermQueryOptions).then((items) => {\r\n        req.erm.result = items\r\n        req.erm.statusCode = 200\r\n\r\n        if (options.totalCountHeader && !req._ermQueryOptions['distinct']) {\r\n          options.contextFilter(model, req, (countFilteredContext) => {\r\n            buildQuery(countFilteredContext.count(), _.assign(req._ermQueryOptions, {\r\n              skip: 0,\r\n              limit: 0\r\n            })).then((count) => {\r\n              req.erm.totalCount = count\r\n              next()\r\n            }, errorHandler(req, res, next))\r\n          })\r\n        } else {\r\n          next()\r\n        }\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function getCount (req, res, next) {\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(filteredContext.count(), req._ermQueryOptions).then((count) => {\r\n        req.erm.result = { count: count }\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function getShallow (req, res, next) {\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).then((item) => {\r\n        if (!item) {\r\n          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n        }\r\n\r\n        for (let prop in item) {\r\n          item[prop] = typeof item[prop] === 'object' && prop !== '_id' ? true : item[prop]\r\n        }\r\n\r\n        req.erm.result = item\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function deleteItems (req, res, next) {\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(filteredContext.remove(), req._ermQueryOptions).then(() => {\r\n        req.erm.statusCode = 204\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function getItem (req, res, next) {\r\n    if (isDistinctExcluded(req)) {\r\n      req.erm.result = []\r\n      req.erm.statusCode = 200\r\n      return next()\r\n    }\r\n\r\n    options.contextFilter(model, req, (filteredContext) => {\r\n      buildQuery(findById(filteredContext, req.params.id), req._ermQueryOptions).then((item) => {\r\n        if (!item) {\r\n          return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n        }\r\n\r\n        req.erm.result = item\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    })\r\n  }\r\n\r\n  function deleteItem (req, res, next) {\r\n    if (options.findOneAndRemove) {\r\n      options.contextFilter(model, req, (filteredContext) => {\r\n        findById(filteredContext, req.params.id).findOneAndRemove().then((item) => {\r\n          if (!item) {\r\n            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n          }\r\n\r\n          req.erm.statusCode = 204\r\n\r\n          next()\r\n        }, errorHandler(req, res, next))\r\n      })\r\n    } else {\r\n      req.erm.document.remove().then(() => {\r\n        req.erm.statusCode = 204\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    }\r\n  }\r\n\r\n  function createObject (req, res, next) {\r\n    req.body = options.filter.filterObject(req.body || {}, {\r\n      access: req.access,\r\n      populate: req._ermQueryOptions.populate\r\n    })\r\n\r\n    if (model.schema.options._id) {\r\n      delete req.body._id\r\n    }\r\n\r\n    if (model.schema.options.versionKey) {\r\n      delete req.body[model.schema.options.versionKey]\r\n    }\r\n\r\n    model.create(req.body).then((item) => model.populate(item, req._ermQueryOptions.populate || [])).then((item) => {\r\n      req.erm.result = item\r\n      req.erm.statusCode = 201\r\n\r\n      next()\r\n    }, errorHandler(req, res, next))\r\n  }\r\n\r\n  function modifyObject (req, res, next) {\r\n    req.body = options.filter.filterObject(req.body || {}, {\r\n      access: req.access,\r\n      populate: req._ermQueryOptions.populate\r\n    })\r\n\r\n    delete req.body._id\r\n\r\n    if (model.schema.options.versionKey) {\r\n      delete req.body[model.schema.options.versionKey]\r\n    }\r\n\r\n    function depopulate (src) {\r\n      let dst = {}\r\n\r\n      for (let key in src) {\r\n        const path = model.schema.path(key)\r\n\r\n        if (path && path.caster && path.caster.instance === 'ObjectID') {\r\n          if (_.isArray(src[key])) {\r\n            for (let j = 0; j < src[key].length; ++j) {\r\n              if (typeof src[key][j] === 'object') {\r\n                dst[key] = dst[key] || {}\r\n                dst[key][j] = src[key][j]._id\r\n              }\r\n            }\r\n          } else if (_.isPlainObject(src[key])) {\r\n            dst[key] = src[key]._id\r\n          }\r\n        } else if (_.isPlainObject(src[key])) {\r\n          if (path && path.instance === 'ObjectID') {\r\n            dst[key] = src[key]._id\r\n          } else {\r\n            dst[key] = depopulate(src[key])\r\n          }\r\n        }\r\n\r\n        if (_.isUndefined(dst[key])) {\r\n          dst[key] = src[key]\r\n        }\r\n      }\r\n\r\n      return dst\r\n    }\r\n\r\n    const cleanBody = moredots(depopulate(req.body))\r\n\r\n    if (options.findOneAndUpdate) {\r\n      options.contextFilter(model, req, (filteredContext) => {\r\n        findById(filteredContext, req.params.id).findOneAndUpdate({}, {\r\n          $set: cleanBody\r\n        }, {\r\n          new: true,\r\n          runValidators: options.runValidators\r\n        }).exec().then((item) => model.populate(item, req._ermQueryOptions.populate || [])).then((item) => {\r\n          if (!item) {\r\n            return errorHandler(req, res, next)(new Error(http.STATUS_CODES[404]))\r\n          }\r\n\r\n          req.erm.result = item\r\n          req.erm.statusCode = 200\r\n\r\n          next()\r\n        }, errorHandler(req, res, next))\r\n      })\r\n    } else {\r\n      for (let key in cleanBody) {\r\n        req.erm.document.set(key, cleanBody[key])\r\n      }\r\n\r\n      req.erm.document.save().then((item) => model.populate(item, req._ermQueryOptions.populate || [])).then((item) => {\r\n        req.erm.result = item\r\n        req.erm.statusCode = 200\r\n\r\n        next()\r\n      }, errorHandler(req, res, next))\r\n    }\r\n  }\r\n\r\n  return { getItems, getCount, getItem, getShallow, createObject, modifyObject, deleteItems, deleteItem }\r\n}\r\n"]}