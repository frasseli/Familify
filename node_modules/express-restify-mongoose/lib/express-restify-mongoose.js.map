{"version":3,"sources":["../src/express-restify-mongoose.js"],"names":["util","require","_","Filter","customDefaults","excludedMap","getDefaults","defaults","clone","prefix","version","idProperty","findOneAndUpdate","findOneAndRemove","lean","restify","runValidators","allowRegex","private","protected","app","model","opts","options","assign","access","ensureContentType","filterAndFindById","onError","outputFn","prepareQuery","prepareOutput","isArray","Error","schema","eachPath","name","path","toLowerCase","push","filter","filteredKeys","modelName","preMiddleware","preCreate","preRead","preUpdate","preDelete","contextFilter","req","done","postCreate","postRead","postUpdate","postDelete","ops","uriItem","indexOf","uriItems","replace","uriCount","uriShallow","isUndefined","delete","del","use","res","next","erm","accessMiddleware","get","getItems","getCount","getItem","getShallow","post","createObject","deprecate","modifyObject","put","patch","deleteItems","deleteItem","module","exports","serve"],"mappings":"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","file":"express-restify-mongoose.js","sourcesContent":["const util = require('util')\r\nconst _ = require('lodash')\r\nconst Filter = require('./resource_filter')\r\nlet customDefaults = null\r\nlet excludedMap = {}\r\n\r\nfunction getDefaults () {\r\n  return _.defaults(_.clone(customDefaults) || {}, {\r\n    prefix: '/api',\r\n    version: '/v1',\r\n    idProperty: '_id',\r\n    findOneAndUpdate: true,\r\n    findOneAndRemove: true,\r\n    lean: true,\r\n    restify: false,\r\n    runValidators: false,\r\n    allowRegex: true,\r\n    private: [],\r\n    protected: []\r\n  })\r\n}\r\n\r\nconst restify = function (app, model, opts = {}) {\r\n  let options = {}\r\n  _.assign(options, getDefaults(), opts)\r\n\r\n  const access = require('./middleware/access')\r\n  const ensureContentType = require('./middleware/ensureContentType')(options)\r\n  const filterAndFindById = require('./middleware/filterAndFindById')(model, options)\r\n  const onError = require('./middleware/onError')\r\n  const outputFn = require('./middleware/outputFn')\r\n  const prepareQuery = require('./middleware/prepareQuery')(options)\r\n  const prepareOutput = require('./middleware/prepareOutput')(options, excludedMap)\r\n\r\n  if (!_.isArray(options.private)) {\r\n    throw new Error('\"options.private\" must be an array of fields')\r\n  }\r\n\r\n  if (!_.isArray(options.protected)) {\r\n    throw new Error('\"options.protected\" must be an array of fields')\r\n  }\r\n\r\n  model.schema.eachPath((name, path) => {\r\n    if (path.options.access) {\r\n      switch (path.options.access.toLowerCase()) {\r\n        case 'private':\r\n          options.private.push(name)\r\n          break\r\n        case 'protected':\r\n          options.protected.push(name)\r\n          break\r\n      }\r\n    }\r\n  })\r\n\r\n  options.filter = new Filter({\r\n    model,\r\n    excludedMap,\r\n    filteredKeys: {\r\n      private: options.private,\r\n      protected: options.protected\r\n    }\r\n  })\r\n\r\n  excludedMap[model.modelName] = options.filter.filteredKeys\r\n\r\n  if (!_.isArray(options.preMiddleware)) {\r\n    options.preMiddleware = options.preMiddleware ? [options.preMiddleware] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preCreate)) {\r\n    options.preCreate = options.preCreate ? [options.preCreate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preRead)) {\r\n    options.preRead = options.preRead ? [options.preRead] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preUpdate)) {\r\n    options.preUpdate = options.preUpdate ? [options.preUpdate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.preDelete)) {\r\n    options.preDelete = options.preDelete ? [options.preDelete] : []\r\n  }\r\n\r\n  if (!options.contextFilter) {\r\n    options.contextFilter = (model, req, done) => done(model)\r\n  }\r\n\r\n  if (!_.isArray(options.postCreate)) {\r\n    options.postCreate = options.postCreate ? [options.postCreate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.postRead)) {\r\n    options.postRead = options.postRead ? [options.postRead] : []\r\n  }\r\n\r\n  if (!_.isArray(options.postUpdate)) {\r\n    options.postUpdate = options.postUpdate ? [options.postUpdate] : []\r\n  }\r\n\r\n  if (!_.isArray(options.postDelete)) {\r\n    options.postDelete = options.postDelete ? [options.postDelete] : []\r\n  }\r\n\r\n  if (!options.onError) {\r\n    options.onError = onError(!options.restify)\r\n  }\r\n\r\n  if (!options.outputFn) {\r\n    options.outputFn = outputFn(!options.restify)\r\n  }\r\n\r\n  options.name = options.name || model.modelName\r\n\r\n  const ops = require('./operations')(model, options, excludedMap)\r\n\r\n  let uriItem = `${options.prefix}${options.version}/${options.name}`\r\n  if (uriItem.indexOf('/:id') === -1) {\r\n    uriItem += '/:id'\r\n  }\r\n\r\n  const uriItems = uriItem.replace('/:id', '')\r\n  const uriCount = uriItems + '/count'\r\n  const uriShallow = uriItem + '/shallow'\r\n\r\n  if (_.isUndefined(app.delete)) {\r\n    app.delete = app.del\r\n  }\r\n\r\n  app.use((req, res, next) => {\r\n    req.erm = { model }\r\n    next()\r\n  })\r\n\r\n  const accessMiddleware = options.access ? access(options) : []\r\n\r\n  app.get(uriItems, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItems, prepareOutput)\r\n  app.get(uriCount, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getCount, prepareOutput)\r\n  app.get(uriItem, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getItem, prepareOutput)\r\n  app.get(uriShallow, prepareQuery, options.preMiddleware, options.preRead, accessMiddleware, ops.getShallow, prepareOutput)\r\n\r\n  app.post(uriItems, prepareQuery, ensureContentType, options.preMiddleware, options.preCreate, accessMiddleware, ops.createObject, prepareOutput)\r\n  app.post(uriItem, util.deprecate(prepareQuery, 'express-restify-mongoose: in a future major version, the POST method to update resources will be removed. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput)\r\n\r\n  app.put(uriItem, util.deprecate(prepareQuery, 'express-restify-mongoose: in a future major version, the PUT method will replace rather than update a resource. Use PATCH instead.'), ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput)\r\n  app.patch(uriItem, prepareQuery, ensureContentType, options.preMiddleware, options.findOneAndUpdate ? [] : filterAndFindById, options.preUpdate, accessMiddleware, ops.modifyObject, prepareOutput)\r\n\r\n  app.delete(uriItems, prepareQuery, options.preMiddleware, options.preDelete, ops.deleteItems, prepareOutput)\r\n  app.delete(uriItem, prepareQuery, options.preMiddleware, options.findOneAndRemove ? [] : filterAndFindById, options.preDelete, ops.deleteItem, prepareOutput)\r\n\r\n  return uriItems\r\n}\r\n\r\nmodule.exports = {\r\n  defaults: function (options) {\r\n    customDefaults = options\r\n  },\r\n  serve: restify\r\n}\r\n"]}